name: Build & Push Docker image (latest + semver)

on:
  push:
    branches: ["main"]

concurrency:
  group: dockerhub-release-main
  cancel-in-progress: false

jobs:
  version:
    name: Compute next version from LAST commit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.ver.outputs.version }}
      git_tag: ${{ steps.ver.outputs.git_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version
        id: ver
        shell: bash
        run: |
          set -euo pipefail

          # 1. Находим последний базовый тег
          LAST_TAG="$(git describe --tags --abbrev=0 --match 'v[0-9]*.[0-9]*.[0-9]*' 2>/dev/null || true)"
          if [[ -z "${LAST_TAG}" ]]; then
            BASE_VERSION="0.0.0"
          else
            BASE_VERSION="${LAST_TAG#v}"
          fi
          echo "Base version: ${BASE_VERSION}"

          # 2. Берем ТОЛЬКО ПОСЛЕДНИЙ коммит (subject + body)
          RAW_COMMIT="$(git log -1 --no-color --pretty=format:'%s%n%b')"
          SUBJECT="$(echo "${RAW_COMMIT}" | head -n 1 | tr -d '\r')"
          echo "Analyzing commit: ${SUBJECT}"

          # Регулярка для Conventional Commits
          HEADER_RE='^(feat|fix|perf|refactor|chore|docs|style|test|build|ci|revert)(\([^)]+\))?(!)?: .+'

          if ! [[ "${SUBJECT}" =~ ${HEADER_RE} ]]; then
            echo "ERROR: Latest commit does not follow Conventional Commits: ${SUBJECT}"
            echo "Example: 'feat: add arm64 support' or 'fix: resolve memory leak'"
            exit 1
          fi

          TYPE="${BASH_REMATCH[1]}"
          BANG="${BASH_REMATCH[3]:-}"

          # Определение силы изменения (BUMP)
          BUMP="none"
          if [[ "${BANG}" == "!" ]] || echo "${RAW_COMMIT}" | grep -Eq '(^|\n)BREAKING CHANGE:'; then
            BUMP="major"
          elif [[ "${TYPE}" == "feat" ]]; then
            BUMP="minor"
          elif [[ "${TYPE}" == "fix" || "${TYPE}" == "perf" ]]; then
            BUMP="patch"
          fi

          if [[ "${BUMP}" == "none" ]]; then
             echo "Info: Commit type '${TYPE}' does not trigger a version bump. Defaulting to patch."
             BUMP="patch"
          fi

          # 3. Инкремент версии
          IFS='.' read -r MAJOR MINOR PATCH <<< "${BASE_VERSION}"
          case "${BUMP}" in
            major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR+1)); PATCH=0 ;;
            patch) PATCH=$((PATCH+1)) ;;
          esac

          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          GIT_TAG="v${VERSION}"

          echo "Computed bump: ${BUMP}"
          echo "Next version: ${VERSION}"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "git_tag=${GIT_TAG}" >> "$GITHUB_OUTPUT"

  docker:
    name: Build & push (multi-arch)
    runs-on: ubuntu-latest
    needs: [version]
    env:
      IMAGE: smplay/my-vite-frontend
      VERSION: ${{ needs.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # QEMU нужен для эмуляции ARM64 на x86 раннере GitHub
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            VITE_API_BASE_URL=/api
          push: true
          # ТЕПЕРЬ СОБИРАЕМ ПОД ОБЕ ПЛАТФОРМЫ
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE }}:latest
            ${{ env.IMAGE }}:${{ env.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  tag:
    name: Push Git Tag
    runs-on: ubuntu-latest
    needs: [version, docker]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push git tag
        shell: bash
        env:
          GIT_TAG: ${{ needs.version.outputs.git_tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${GIT_TAG}" -m "Release ${GIT_TAG}"
          git push origin "${GIT_TAG}"
